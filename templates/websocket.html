<!-- TODO: JSON ë°ì´í„° ì¤‘ ìŒì„± ë°ì´í„° Parsing í›„ "audio-player"ì— ë„£ê¸° -->
<script type="module">
    import firebaseConfig from '/config/config_mod.js';

    firebase.initializeApp(firebaseConfig);

    var database = firebase.database();
    const voice_flag = true;
    const haptic_flag = true;

    function writePositionData(value) {
        firebase.database().ref('position/').set(value);
    }

    // parsing ëœ ìŒì„± ë°ì´í„°ë¥¼ "audio-player"ì— ë„£ê¸°
    function playAudio(audioData) {
        const audioPlayer = document.getElementById('audio-player');

        // ì´ì „ ì¬ìƒì´ ìˆìœ¼ë©´ ì¤‘ë‹¨
        if (!audioPlayer.paused) {
            audioPlayer.pause();
        }

        // ì¬ìƒ ì‹œì‘ ìœ„ì¹˜ ì´ˆê¸°í™”
        audioPlayer.currentTime = 0;

        // ìƒˆë¡œìš´ ì†ŒìŠ¤ë¡œ ì„¤ì • í›„ load
        audioPlayer.src = audioData;
        audioPlayer.load();

        // ì•ˆì „í•˜ê²Œ ì¬ìƒ
        audioPlayer.play().catch((error) => {
            console.warn("ğŸ§ ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:", error);
        });
    }

    const ws = new WebSocket("ws://localhost:8000/ws");

    ws.onopen = function () {
        console.log("WebSocket connection opened");
    };

    ws.onmessage = function (event) {
        const position = JSON.parse(event.data);
        const positionText = position.text;
        const positionData = position.data;
        const recordingElement = document.getElementById('recording');

        if (positionText) {
            if (positionText == "finger_out") {
                const serverResponse = document.getElementById('server-response');
                if (serverResponse) {
                    serverResponse.innerText = "ì†ê°€ë½ì´ ì‚¬ë¼ì¡Œì–´ìš”. í•œ ì† ê°€ë½ì„ í•€ ìƒíƒœë¡œ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”ğŸ¥º";
                }
            }

            else if (positionText == "pallte_out") {
                const serverResponse = document.getElementById('server-response');
                if (serverResponse) {
                    serverResponse.innerText = "ì†ìœ¼ë¡œ ê°€ë ¤ì ¸ì„œ íŒ”ë ˆíŠ¸ë¥¼ ì¸ì‹í•˜ì§€ ëª»í•œ ê²ƒ ê°™ì•„ìš”. íŒ”ë ˆíŠ¸ ì•„ë˜ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”ğŸ¥º";
                }
            }

            else if (positionText == "hide_pallete") {
                const serverResponse = document.getElementById('server-response');
                if (serverResponse) {
                    serverResponse.innerText = "í•´ë‹¹í•˜ëŠ” ì„€ë„ìš° ìƒ‰ìƒì„ ì†ìœ¼ë¡œ ê°€ë¦¬ì‹  ê²ƒ ê°™ì•„ìš”. íŒ”ë ˆíŠ¸ ì•„ë˜ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”ğŸ¥º";
                }
            }

            recordingElement.style.display = "none";
            let textElement = document.getElementById('textRecording');

            if (!textElement) {
                textElement = document.createElement('p');
                textElement.id = 'textRecording';
                textElement.classList.add('black-han-sans-regular', 'fs-1', 'p-5', 'text-center');
                recordingElement.parentNode.insertBefore(textElement, recordingElement.nextSibling);
            }
            textElement.textContent = "Haptic Guidanceê°€ ì‹¤í–‰ë¼ìš”ğŸ˜Š";

            if (positionText === "False") {
                captureImage().then(imageBlob => {
                    ws.send(imageBlob);
                });
            }
        }
        if ([0, 5, 6].includes(positionData)) {
            recordingElement.style.display = "block";
            const textElement = document.getElementById('textRecording');
            if (textElement) {
                textElement.remove();
            }
        }

        if (haptic_flag) {
            writePositionData(positionData);
        }
        if (voice_flag && position.audio) {
            console.log("ğŸ”Š ìŒì„± ì¬ìƒ ì‹œì‘:", position.audio);
            playAudio(position.audio);
        } else {
            console.log("â¸ï¸ ìŒì„± ì—†ìŒ ë˜ëŠ” ë¹„í™œì„±í™” ìƒíƒœ", position);
        }
    };

    ws.onclose = function () {
        console.log("WebSocket connection closed");
    };

    ws.onerror = function (error) {
        console.error("WebSocket error:", error);
    };

</script>